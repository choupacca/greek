{% extends "base.html" %}
{% block content %}

<h1 class="text-3xl font-bold mb-4">{{ title }}</h1>

<input id="search" type="text" placeholder="ÐŸÐ¾Ð¸ÑÐºâ€¦"
       class="w-full mb-4 px-3 py-2 border rounded-md"
       oninput="filterRows()">

{% if cat in ['vocab', 'phrases'] %}
<button onclick="startDrill()"
        class="mb-4 px-4 py-2 bg-amber-500 text-white rounded-md">
  ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸
</button>
{% endif %}

<table id="datatable" class="w-full border-collapse">
  {% if headers %}
    <thead class="bg-gray-100">
      <tr>
        {% for h in headers %}
          <th class="border p-2 text-left font-semibold cursor-pointer select-none"
              onclick="sortCol({{ loop.index0 }})">
            {{ h }} <span id="arrow{{ loop.index0 }}"></span>
          </th>
        {% endfor %}
      </tr>
    </thead>
  {% endif %}
  <tbody>
    {% for row in rows %}
      <tr class="odd:bg-white even:bg-gray-50">
        {% for cell in row %}
          {% set greek = cell.split('(')[0].replace('â€”', ' ').replace('-', ' ').strip().rstrip('!?.,Â·') %}
          <td class="border px-3 py-2">
            <span class="word">{{ cell }}</span>
            {% if greek|is_greek %}
              <button onclick="play('{{ greek }}')"
                      class="ml-2 text-indigo-500 hover:text-indigo-700">ðŸ”Š</button>
            {% endif %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- â”€â”€â”€â”€â”€ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº â”€â”€â”€â”€â”€ -->
<div id="modal" class="fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-white"></div>

  <div class="relative z-10 flex flex-col items-center justify-center
              h-full w-full max-w-lg mx-auto p-8">
    <button onclick="closeDrill()"
            class="absolute right-4 top-4 text-2xl text-gray-500 hover:text-gray-700">âœ•</button>
    <button id="speakBtn"
            class="absolute left-4 top-4 text-2xl text-indigo-500 hover:text-indigo-700">ðŸ”Š</button>

    <div id="front" class="text-2xl font-bold mb-6 text-center"></div>

    <button id="flipBtn"
            class="px-6 py-3 bg-indigo-600 text-white rounded-md">
      ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚
    </button>
  </div>
</div>

<script>
/* ---------- Ð¿Ð¾Ð¸ÑÐº ---------- */
function filterRows(){
  const q=document.getElementById('search').value.toLowerCase();
  document.querySelectorAll('#datatable tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
}

/* ---------- Ð¾Ð·Ð²ÑƒÑ‡ÐºÐ° ---------- */
function play(text){
  text = text.replace(/[!?.,Â·]/g,'').trim();
  new Audio('/tts?q='+encodeURIComponent(text)).play();
}

/* ---------- ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° ---------- */
let sortState={};
function sortCol(idx){
  const tbody=document.querySelector('#datatable tbody');
  const rows=[...tbody.querySelectorAll('tr')];
  const order=sortState[idx]==='asc'?'desc':'asc';
  sortState[idx]=order;

  rows.sort((a,b)=>{
    const A=a.children[idx].innerText.trim().toLowerCase();
    const B=b.children[idx].innerText.trim().toLowerCase();
    const cmp=A.localeCompare(B,'el',{sensitivity:'accent'})||
              A.localeCompare(B,'ru',{sensitivity:'accent'})||
              A.localeCompare(B);
    return order==='asc'?cmp:-cmp;
  });
  rows.forEach(tr=>tbody.appendChild(tr));
  document.querySelectorAll('[id^=arrow]').forEach(el=>el.textContent='');
  document.getElementById('arrow'+idx).textContent = order==='asc'?'â–²':'â–¼';
}

/* ---------- ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ ---------- */
let cards=[],idx=0;
function startDrill(){
  const ruIdx = [...document.querySelectorAll('#datatable thead th')]
                .findIndex(th =>
                  th.textContent.trim().toLowerCase().startsWith('Ñ€ÑƒÑÑÐºÐ¸Ð¹')
                );
  if(ruIdx===-1){alert('ÐÐµÑ‚ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸ "Ð ÑƒÑÑÐºÐ¸Ð¹"');return;}

  cards=[...document.querySelectorAll('#datatable tbody tr')].map(tr=>{
    const front=tr.querySelector('.word').innerText.split('(')[0].trim();
    const back =tr.children[ruIdx].innerText.trim();
    return [front, back];
  });
  shuffle(cards); idx=0;
  document.addEventListener('keydown', escClose);
  document.getElementById('modal').classList.remove('hidden');
  nextCard();
}
function nextCard(){
  if(idx>=cards.length){ return closeDrill(); }
  const [front,back]=cards[idx++];
  const f=document.getElementById('front');
  const btn=document.getElementById('flipBtn');
  f.textContent=front;
  btn.textContent='ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚';
  btn.onclick=()=>{
    f.textContent=back||'(Ð½ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð°)';
    btn.textContent = idx<cards.length ? 'Ð”Ð°Ð»ÑŒÑˆÐµ' : 'Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ';
    btn.onclick     = idx<cards.length ? nextCard : closeDrill;
  }
  document.getElementById('speakBtn').onclick = ()=>play(front);
}
function closeDrill(){
  document.getElementById('modal').classList.add('hidden');
  document.removeEventListener('keydown', escClose);
}
function escClose(e){ if(e.key==='Escape') closeDrill(); }
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

</script>
{% endblock %}